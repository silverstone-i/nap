sequenceDiagram
    autonumber
    title Login / Refresh (token issuance)
    participant Client
    participant API
    participant Postgres as PG (source of truth)
    participant Redis

    Client->>API: POST /auth/login (or /auth/refresh)
    API->>PG: Verify user, load roles/policy
    API->>API: Build canonical perms → calc perm_hash (ph)
    API->>Redis: SET perm:<uid>:<tenant> = {perms, hash, version}
    API->>Redis: SET ctx:<sid> = {tenantSchema, roleId, ph} (TTL≈15m)
    API-->>Client: Set cookies (access, refresh) with ph in JWT