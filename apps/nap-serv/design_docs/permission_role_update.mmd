sequenceDiagram
    autonumber
    title Permission / Role Change (admin action)
    participant Admin
    participant API
    participant Postgres as PG (authoritative)
    participant Redis
    participant Workers as Other App Nodes

    Admin->>API: PATCH /admin/users/:id/roles ...
    API->>PG: Update roles/policy (TX)
    API->>PG: Recompute effective perms (SELECT)
    API->>API: calc new perm_hash + bump version
    API->>Redis: SET perm:<uid>:<tenant> = {perms, hash, version}
    API->>Redis: PUBLISH perm:update {uid, tenant, version, hash}
    Redis-->>Workers: invalidate local LRU entries
    note over Workers: Next request compares JWT.ph vs Redis.hash â†’ triggers refresh